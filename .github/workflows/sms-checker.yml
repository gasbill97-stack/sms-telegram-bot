name: SMS to Telegram Forwarder

on:
  # Runs every 2 minutes (adjust as needed)
  schedule:
    - cron: '*/2 * * * *'
  # Allows manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  check-and-forward:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install axios
      
      - name: Check for new SMS and send to Telegram
        env:
          # Your Firebase URL (DO NOT change this)
          FIREBASE_URL: 'https://billupdate-2c426-default-rtdb.asia-southeast1.firebasedatabase.app'
          # These secrets MUST be set in GitHub Settings > Secrets > Actions
          BOT_TOKEN: ${{ 8194289567 }}
          CHAT_ID: ${{ 8201318151:AAGelxS1S7B9Zj9Ck9qd5UeK8Kv0573I18Y }}
        run: |
          cat > sms-forwarder.js << 'EOF'
          const axios = require('axios');
          
          const FIREBASE_URL = process.env.FIREBASE_URL;
          const BOT_TOKEN = process.env.BOT_TOKEN;
          const CHAT_ID = process.env.CHAT_ID;
          
          console.log('ðŸš€ Starting SMS forwarder...');
          console.log('ðŸ“¡ Firebase URL:', FIREBASE_URL);
          
          async function forwardSMS() {
            try {
              // CORRECT PATH for your nested structure: /messages/messages
              const queryUrl = ${FIREBASE_URL}/messages/messages.json?orderBy="telegram_sent"&equalTo=null&limitToLast=10;
              console.log('ðŸ” Querying:', queryUrl);
              
              const response = await axios.get(queryUrl);
              const messages = response.data;
              
              if (!messages || Object.keys(messages).length === 0) {
                console.log('ðŸ“­ No unprocessed messages found.');
                return;
              }
              
              console.log(âœ… Found ${Object.keys(messages).length} new message(s));
              
              // Process each message
              for (const [messageId, messageData] of Object.entries(messages)) {
                if (!messageData || messageData.telegram_sent) continue;
                
                console.log(ðŸ“± Processing: ${messageId});
                console.log('   Full message data:', JSON.stringify(messageData, null, 2));
                
                // Format Telegram message with ALL details
                // This shows the FULL USER MESSAGE as requested
                const telegramMessage = `
ðŸ”” *NEW SMS ALERT* ðŸ””

ðŸ“ž *Sender:* \${messageData.sender || 'Unknown'}\
ðŸ“ *Message:* ${messageData.message || 'No message content'}
â° *Time:* ${new Date(messageData.timestamp || Date.now()).toLocaleString()}
ðŸ†” *ID:* \${messageId}\

ðŸ’¾ *Full Data:*
\\\`json
${JSON.stringify(messageData, null, 2)}
\\\`
                `.trim();
                
                try {
                  // Send to Telegram
                  console.log('   Sending to Telegram...');
                  const telegramResponse = await axios.post(
                    https://api.telegram.org/bot${BOT_TOKEN}/sendMessage,
                    {
                      chat_id: CHAT_ID,
                      text: telegramMessage,
                      parse_mode: 'Markdown',
                      disable_web_page_preview: true
                    }
                  );
                  
                  console.log(`   âœ… Telegram sent (ID: ${telegramResponse.data.result.message_id})`);
                  
                  // Mark as sent in Firebase
                  const updateUrl = ${FIREBASE_URL}/messages/messages/${messageId}.json;
                  await axios.patch(updateUrl, {
                    telegram_sent: true,
                    sent_at: Date.now(),
                    sent_via: 'github_actions'
                  });
                  
                  console.log(`   âœ… Marked as sent in Firebase`);
                  
                } catch (error) {
                  console.error(`   âŒ Failed to process ${messageId}:`, error.message);
                  if (error.response) {
                    console.error('   Response error:', error.response.data);
                  }
                }
              }
              
            } catch (error) {
              console.error('ðŸ”¥ Critical error:', error.message);
              if (error.response) {
                console.error('Response data:', error.response.data);
                console.error('Response status:', error.response.status);
              }
              process.exit(1);
            }
          }
          
          forwardSMS();
          EOF
          
          # Run the script
          node sms-forwarder.js
          
          echo "âœ… Workflow completed at $(date)"
