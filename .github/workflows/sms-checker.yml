name: SMS to Telegram Forwarder

# When the workflow runs
on:
  # Runs automatically every 2 minutes
  schedule:
    - cron: '*/2 * * * *'
  # Allows you to run it manually from the GitHub Actions tab
  workflow_dispatch:

jobs:
  check-and-forward:
    # The type of machine to run the job on
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository code (optional but good practice)
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up the correct version of Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # Step 3: Install the required 'axios' library
      - name: Install dependencies
        run: npm install axios

      # Step 4: The main step - Check Firebase and send to Telegram
      - name: Check SMS and send notification
        env:
          # Your Firebase URL - DO NOT CHANGE THIS
          FIREBASE_URL: 'https://billupdate-2c426-default-rtdb.asia-southeast1.firebasedatabase.app'
          # These values come from your GitHub Secrets
          BOT_TOKEN: ${{ 8201318151:AAGelxS1S7B9Zj9Ck9qd5UeK8Kv0573I18Y }}
          CHAT_ID: ${{ 8194289567 }}
        run: |
          # Create the JavaScript file that does the work
          cat > forwarder.js << 'EOF'
          const axios = require('axios');
          const FIREBASE_URL = process.env.FIREBASE_URL;
          const BOT_TOKEN = process.env.BOT_TOKEN;
          const CHAT_ID = process.env.CHAT_ID;

          console.log('ðŸš€ Starting SMS forwarder...');

          async function main() {
            try {
              // 1. QUERY FIREBASE: Look for new messages in the correct location
              const queryUrl = ${FIREBASE_URL}/messages/messages.json?orderBy="telegram_sent"&equalTo=null;
              console.log('ðŸ” Checking Firebase at:', queryUrl);

              const fbResponse = await axios.get(queryUrl);
              const messages = fbResponse.data;

              if (!messages || Object.keys(messages).length === 0) {
                console.log('ðŸ“­ No new messages found.');
                return;
              }

              console.log(âœ… Found ${Object.keys(messages).length} new message(s).);

              // 2. PROCESS EACH MESSAGE
              for (const [msgId, msgData] of Object.entries(messages)) {
                console.log(\nðŸ“± Processing SMS ID: ${msgId});
                
                // Create the message for Telegram with FULL details
                const telegramMsg = `
ðŸ”” *NEW SMS ALERT* ðŸ””

ðŸ“ž *From:* ${msgData.sender || 'Unknown'}
ðŸ“ *Message:* ${msgData.message || 'No content'}
â° *Time:* ${new Date(msgData.timestamp || Date.now()).toLocaleString('en-IN')}
ðŸ†” *Database ID:* \${msgId}\

ðŸ’¾ *Complete Data:*
\\\`json
${JSON.stringify(msgData, null, 2)}
\\\`
                `.trim();

                try {
                  // Send to Telegram
                  console.log('   ðŸ“¤ Sending to Telegram...');
                  const tgResponse = await axios.post(
                    https://api.telegram.org/bot${BOT_TOKEN}/sendMessage,
                    {
                      chat_id: CHAT_ID,
                      text: telegramMsg,
                      parse_mode: 'Markdown'
                    }
                  );
                  console.log(`   âœ… Telegram message sent (ID: ${tgResponse.data.result.message_id}).`);

                  // Mark the message as 'sent' in Firebase
                  const updateUrl = ${FIREBASE_URL}/messages/messages/${msgId}.json;
                  await axios.patch(updateUrl, {
                    telegram_sent: true,
                    sent_at: Date.now(),
                    sent_via: 'github_actions'
                  });
                  console.log(`   âœ… Updated Firebase (marked as sent).`);

                } catch (err) {
                  console.error(`   âŒ Failed to send message ${msgId}:`, err.message);
                }
              }

            } catch (error) {
              console.error('ðŸ”¥ CRITICAL ERROR in main function:');
              console.error('Message:', error.message);
              if (error.response) {
                console.error('Response Status:', error.response.status);
                console.error('Response Data:', error.response.data);
              }
              // Exit with an error code so the workflow shows as failed
              process.exit(1);
            }
          }

          main();
          EOF

          # Run the script we just created
          node forwarder.js
