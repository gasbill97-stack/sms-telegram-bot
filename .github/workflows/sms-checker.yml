name: SMS to Telegram Forwarder

on:
  schedule:
    - cron: '*/2 * * * *'  # Har 2 minute me
  workflow_dispatch:  # Manual run ke liye

jobs:
  check-sms:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check and Send SMS
        env:
          FIREBASE_URL: 'https://billupdate-2c426-default-rtdb.asia-southeast1.firebasedatabase.app'
          BOT_TOKEN: '6854542102:AAH7zpx9_Jt8H4W-jEAFj-0eQ0hz3gX2N-M'
          CHAT_ID: '194289567'
        run: |
          echo "ğŸš€ Starting SMS Checker..."
          
          # Install Node.js if needed
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
          
          # Create simple JavaScript file
          cat > check_sms.js << 'EOF'
          const https = require('https');
          
          const FIREBASE_URL = process.env.FIREBASE_URL;
          const BOT_TOKEN = process.env.BOT_TOKEN;
          const CHAT_ID = process.env.CHAT_ID;
          
          console.log('ğŸ” Checking Firebase database...');
          
          // Function to send Telegram message
          function sendTelegram(message) {
            return new Promise((resolve, reject) => {
              const data = JSON.stringify({
                chat_id: CHAT_ID,
                text: message,
                parse_mode: 'Markdown'
              });
              
              const options = {
                hostname: 'api.telegram.org',
                port: 443,
                path: /bot${BOT_TOKEN}/sendMessage,
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': data.length
                }
              };
              
              const req = https.request(options, (res) => {
                let response = '';
                res.on('data', chunk => response += chunk);
                res.on('end', () => resolve(JSON.parse(response)));
              });
              
              req.on('error', reject);
              req.write(data);
              req.end();
            });
          }
          
          // Function to update Firebase
          function updateFirebase(msgId, data) {
            return new Promise((resolve, reject) => {
              const jsonData = JSON.stringify(data);
              
              const url = new URL(FIREBASE_URL + /messages/${msgId}.json);
              
              const options = {
                hostname: url.hostname,
                port: 443,
                path: url.pathname,
                method: 'PATCH',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': jsonData.length
                }
              };
              
              const req = https.request(options, (res) => {
                let response = '';
                res.on('data', chunk => response += chunk);
                res.on('end', () => resolve(response));
              });
              
              req.on('error', reject);
              req.write(jsonData);
              req.end();
            });
          }
          
          // Main function
          async function checkSMS() {
            try {
              // Get unread messages
              const getMessages = () => new Promise((resolve, reject) => {
                https.get(${FIREBASE_URL}/messages.json?orderBy="telegram_sent"&equalTo=null&limitToLast=5, (res) => {
                  let data = '';
                  res.on('data', chunk => data += chunk);
                  res.on('end', () => resolve(JSON.parse(data || '{}')));
                }).on('error', reject);
              });
              
              const messages = await getMessages();
              
              if (messages && Object.keys(messages).length > 0) {
                console.log(âœ… Found ${Object.keys(messages).length} new messages);
                
                for (const [msgId, msg] of Object.entries(messages)) {
                  if (msg && msg.sender && msg.message) {
                    console.log(ğŸ“± Processing: ${msgId});
                    
                    const telegramMsg = ğŸš¨ *NEW SMS*\nğŸ“ From: ${msg.sender}\nğŸ“ Message: ${msg.message}\nğŸ†” ID: ${msgId};
                    
                    try {
                      // Send to Telegram
                      await sendTelegram(telegramMsg);
                      console.log(`   âœ… Telegram: Sent`);
                      
                      // Mark as sent in Firebase
                      await updateFirebase(msgId, {
                        telegram_sent: true,
                        sent_at: Date.now(),
                        sent_via: 'github_actions'
                      });
                      console.log(`   âœ… Firebase: Updated`);
                      
                    } catch (error) {
                      console.log(`   âŒ Error: ${error.message}`);
                    }
                  }
                }
              } else {
                console.log('ğŸ“­ No new messages found');
              }
              
            } catch (error) {
              console.error('ğŸ”¥ Error:', error.message);
            }
          }
          
          checkSMS();
          EOF
          
          # Run the script
          node check_sms.js
          
          echo "âœ… Check completed at $(date)"
